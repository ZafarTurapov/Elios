# -*- coding: utf-8 -*-
import sys
import os
import os as _os

import json
import yfinance as yf
from ta.momentum import RSIIndicator
from ta.trend import EMAIndicator
from ta.volatility import AverageTrueRange
from openai import OpenAI
import shutil
import numpy as np
import requests
from datetime import datetime, timedelta, timezone
from collections import defaultdict
from pathlib import Path
import csv
import re

# Ð“Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð¿Ð°ÐºÐµÑ‚Ð° core Ð¿Ñ€Ð¸ Ð¿Ñ€ÑÐ¼Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ
if "/root/stockbot" not in sys.path:
    sys.path.insert(0, "/root/stockbot")

# ÐšÐ°Ð»ÐµÐ½Ð´Ð°Ñ€ÑŒ Ñ€Ñ‹Ð½ÐºÐ° (Ð¼ÑÐ³ÐºÐ¸Ð¹ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚ â€” Ð½Ðµ Ð»Ð¾Ð¼Ð°ÐµÐ¼ÑÑ, ÐµÑÐ»Ð¸ Ñ„Ð°Ð¹Ð»Ð° Ð½ÐµÑ‚)
try:
    from core.utils.market_calendar import is_market_open_today
except Exception:
    def is_market_open_today():
        return True

from core.trading.anomaly_detector import detect_anomalies
from core.trading.alpha_utils import calculate_alpha_score
# --- Optional squeeze provider ---
try:
    from core.trading.squeeze_providers import get_squeeze_features  # returns dict: si_pct, dtc, float_m, fee_pct, util_pct
except Exception:
    def get_squeeze_features(symbol, **kwargs):
        return {"si_pct": None, "dtc": None, "float_m": None, "fee_pct": None, "util_pct": None, "source":"none"}
\1

# --- Ð•Ð´Ð¸Ð½Ñ‹Ð¹ ÑÐ¼Ð¸Ñ‚Ñ‚ÐµÑ€ Ð°Ð»Ñ‘Ñ€Ñ‚Ð¾Ð² Ð² Telegram Ð² Ñ‚Ñ€ÐµÐ±ÑƒÐµÐ¼Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ
def _tg_new_signal(
    symbol: str,
    price: float,
    percent_change: float,
    rsi: float,
    ema_dev: float,
    atr_pct: float,
    volatility_pct: float,
    gpt_reply: str = ""
) -> None:
    """
    Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:
      ðŸ“Š ÐÐ¾Ð²Ñ‹Ð¹ ÑÐ¸Ð³Ð½Ð°Ð» (BUY)
      ðŸ“Œ $TICKER @ 123.45
      âˆ†%=4.49% | RSI=68.44 | EMA dev=2.92%
      ATR%=2.23 | Vol=1.52%
      ðŸ¤– GPT: "â€¦"
    """
    try:
        from core.utils.telegram import send_telegram_message
        msg = (
            f"\ud83d\udcca ÐÐ¾Ð²Ñ‹Ð¹ ÑÐ¸Ð³Ð½Ð°Ð» (BUY)\n"
            f"\ud83d\udccd ${symbol} @ {price:.2f}\n"
            f"\u2206%={percent_change:.2f}% | RSI={rsi:.2f} | EMA dev={ema_dev:.2f}%\n"
            f"ATR%={atr_pct:.2f} | Vol={volatility_pct:.2f}%\n"
            f"\ud83e\udd16 GPT: \"{gpt_reply}\""
        )
        send_telegram_message(msg)
    except Exception as e:
        print(f"[WARN] Telegram unified signal msg: {e}")

def _gpt_healthcheck():
    try:
        _key = os.getenv("OPENAI_API_KEY") or ""
        if not _key or not _key.startswith("sk-"):
            print("[GPT] OPENAI_API_KEY missing/invalid")
            return False
        r = client.chat.completions.create(
            model=GPT_SIGNAL_MODEL,
            messages=[{"role":"user","content":"ÐžÑ‚Ð²ÐµÑ‚ÑŒ Ñ€Ð¾Ð²Ð½Ð¾ ÑÐ»Ð¾Ð²Ð¾Ð¼ Ð”Ð."}],
            temperature=0, max_tokens=3
        )
        ans = (r.choices[0].message.content or "").strip()
        ok = bool(ans)
        print(f"[GPT] healthcheck: {'OK' if ok else 'EMPTY'} â†’ {ans}")
        try:
            send_telegram_message(f"ðŸ¤– GPT OK: {ans}")
        except Exception as te:
            print(f"[GPT] telegram note failed: {te}")
        return ok
    except Exception as e:
        print(f"[GPT] healthcheck error: {e}")
        return False

        import time, os
        msg = (
            f"\U0001F4CA ÐÐ¾Ð²Ñ‹Ð¹ ÑÐ¸Ð³Ð½Ð°Ð» (BUY)\n"
            f"\U0001F4CD ${symbol} @ {price:.2f}\n"
            f"\u2206%={percent_change:.2f}% | RSI={rsi:.2f} | EMA dev={ema_dev:.2f}%\n"
            f"ATR%={atr_pct:.2f} | Vol={volatility_pct:.2f}%\n"
            f"\U0001F916 GPT: \"{gpt_reply}\""
        )
        send_telegram_message(msg)
        print(f"âœ… TG emit: ${symbol} -> sent")
        time.sleep(float(os.getenv("ELIOS_TG_COOLDOWN_SEC","0.3")))
    except Exception as e:
        print(f"[WARN] Telegram unified signal msg: {e}")
# --- /ELIOS ---
